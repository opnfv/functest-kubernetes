---
- functest-kubernetes-buildparameters: &functest-kubernetes-buildparameters
    name: 'functest-kubernetes-buildparameters'
    parameters:
      - string:
          name: branch
          default: '{branch}'

- projectparameters: &functest-kubernetes-projectparameters
    name: 'functest-kubernetes-projectparameters'
    current-parameters: true

- scm:
    name: functest-kubernetes-gerrit
    scm:
      - git:
          url: https://gerrit.opnfv.org/gerrit/functest-kubernetes
          refspec: '+refs/changes/*:refs/changes/*'
          branches:
            - ${branch}

- job-template:
    name: '{repo}-functest-kubernetes-{container}-{tag}-build'
    <<: *functest-kubernetes-buildparameters
    scm:
      - functest-kubernetes-gerrit
    builders:
      - shell: |
          cd docker/$(echo {container} |cut -d\- -f 2)
          docker build \
            --pull=false --no-cache --force-rm=true \
            --build-arg BRANCH=${{branch}} \
            -t {repo}/functest-kubernetes-{container}:{tag} .

- project:
    name: '{repo}-functest-kubernetes-{container}-{tag}-build'
    container:
      - core
      - healthcheck
      - smoke
      - features
    jobs:
      - '{repo}-functest-kubernetes-{container}-{tag}-build'

- job-template:
    name: '{repo}-functest-kubernetes-{tag}-build'
    project-type: multijob
    <<: *functest-kubernetes-buildparameters
    builders:
      - multijob:
          name: build functest-kubernetes-core
          projects:
            - name: '{repo}-functest-kubernetes-core-{tag}-build'
              <<: *functest-kubernetes-projectparameters
      - multijob:
          name: build functest-kubernetes-healthcheck
          projects:
            - name: '{repo}-functest-kubernetes-healthcheck-{tag}-build'
              <<: *functest-kubernetes-projectparameters
      - multijob:
          name: build all remaining contrainers
          projects:
            - name: '{repo}-functest-kubernetes-smoke-{tag}-build'
              <<: *functest-kubernetes-projectparameters
            - name: '{repo}-functest-kubernetes-features-{tag}-build'
              <<: *functest-kubernetes-projectparameters

- project:
    name: '{repo}-functest-kubernetes-{tag}-build'
    jobs:
      - '{repo}-functest-kubernetes-{tag}-build'

- job-template:
    name: '{repo}-functest-kubernetes-{tag}-gate'
    project-type: multijob
    <<: *functest-kubernetes-buildparameters
    builders:
      - multijob:
          name: build containers
          projects:
            - name: '{repo}-functest-kubernetes-{tag}-build'
              <<: *functest-kubernetes-projectparameters
      - multijob:
          name: basics tests
          projects:
            - name: '{repo}-functest-kubernetes-healthcheck-{tag}-run'
      - multijob:
          name: advanced tests
          projects:
            - name: '{repo}-functest-kubernetes-smoke-{tag}-run'
            - name: '{repo}-functest-kubernetes-features-{tag}-run'

- project:
    name: '{repo}-functest-kubernetes-{tag}-gate'
    jobs:
      - '{repo}-functest-kubernetes-{tag}-gate'
